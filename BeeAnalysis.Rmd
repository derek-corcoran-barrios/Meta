---
title: "Community Analysis Hymenoptera"
author: "Anson Main and Derek Corcoran"
date: "October 5, 2016"
output:
  pdf_document:
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(ggplot2)
library(vegan)
library(stargazer)
library(dplyr)
library(knitr)
library(glmulti)
library(lme4)
```

#Data
This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
BeeDiversity <- read.csv("~/Metanalysis/BeeDiversity.csv")
BeesOnly <- BeeDiversity[1:24,-(1:4)]
row.names(BeesOnly) <- BeeDiversity$FieldID[1:24]
BeesManagement <- BeeDiversity[1:24,1:4]

```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Anosim analisis between Treated and Untreated Fields"}
Bees.dist <- vegdist(BeesOnly)
Bees.ano <- anosim(Bees.dist, BeesManagement$Treatment)
plot(Bees.ano)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Anosim analisis between different management areas"}
Bees.ano2 <- anosim(Bees.dist, BeesManagement[,2])
plot(Bees.ano2)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, results='hide'}
example_NMDS=metaMDS(BeesOnly,k=2,trymax=100)
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}


data.scores <- as.data.frame(scores(example_NMDS))  #Using the scores function from vegan to extract the site scores and convert to a data.frame
data.scores$site <- rownames(data.scores)  # create a column of site names, from the rownames of data.scores
data.scores <- cbind(data.scores, BeesManagement)  #  add the grp variable created earlier
```
##NMDS Treated Untreated
```{r, echo=FALSE, warning=FALSE, message=FALSE}
grp.T <- data.scores[data.scores$Treatment == "treated", ][chull(data.scores[data.scores$Treatment == "treated", c("NMDS1", "NMDS2")]), ]  # hull values for grp Treatment
grp.U <- data.scores[data.scores$Treatment == "untreated", ][chull(data.scores[data.scores$Treatment == "untreated", c("NMDS1", "NMDS2")]), ]  # hull values for grp B

hull.data <- rbind(grp.T, grp.U)  #combine grp.a and grp.b
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Multidimensional Scaling Showing the Overlap of communities between treated and untreated areas"}

ggplot()+  geom_polygon(data=hull.data,aes(x=NMDS1,y=NMDS2,fill=Treatment,group=Treatment),alpha=0.30) + # add the convex hulls
  geom_point(data=data.scores,aes(x=NMDS1,y=NMDS2,shape=Crop,colour=FieldID.1),size=4) + 
  coord_equal() +
  theme_bw() + 
  theme(axis.text.x = element_blank(),  # remove x-axis text
        axis.text.y = element_blank(), # remove y-axis text
        axis.ticks = element_blank(),  # remove axis ticks
        axis.title.x = element_text(size=18), # remove x-axis labels
        axis.title.y = element_text(size=18), # remove y-axis labels
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_blank())
## $ site : chr "ATT2" "IHT3" "FGT3" "FGT2" ...
## $ FieldID : Factor w/ 25 levels "","ATT1","ATT2",..: 3 16 10 9 20 23 21 24 7 12 ...
## $ FieldID.1: Factor w/ 5 levels "","AT","FG","IH",..: 2 4 3 3 5 5 5 5 2 3 ...
## $ Treatment: Factor w/ 3 levels "","treated","untreated": 2 2 2 2 2 2 2 3 3 3 ...
## $ Crop : Factor w/ 8 levels "","corn","grassland",..: 7 2 2 2 2 5 2 6 6 3 ...
```


##NMDS Management Areas
```{r, echo=FALSE, warning=FALSE, message=FALSE}
grp.AT <- data.scores[data.scores$FieldID.1 == "AT", ][chull(data.scores[data.scores$FieldID.1 == "AT", c("NMDS1", "NMDS2")]), ]  # hull values for grp Treatment
grp.FG <- data.scores[data.scores$FieldID.1 == "FG", ][chull(data.scores[data.scores$FieldID.1 == "FG", c("NMDS1", "NMDS2")]), ]  # hull values for grp B
grp.IH <- data.scores[data.scores$FieldID.1 == "IH", ][chull(data.scores[data.scores$FieldID.1 == "IH", c("NMDS1", "NMDS2")]), ]  # hull values for grp Treatment
grp.WC <- data.scores[data.scores$FieldID.1 == "WC", ][chull(data.scores[data.scores$FieldID.1 == "WC", c("NMDS1", "NMDS2")]), ]  # hull values for grp B

site.hull.data <- rbind(grp.AT, grp.FG, grp.IH, grp.WC)  #combine grp.a and grp.b
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Multidimensional Scaling Showing the Overlap of communities between Management Areas"}

ggplot()+  geom_polygon(data=site.hull.data,aes(x=NMDS1,y=NMDS2,fill=FieldID.1,group=FieldID.1),alpha=0.30) + # add the convex hulls
  geom_point(data=data.scores,aes(x=NMDS1,y=NMDS2,shape=Treatment,colour=Crop),size=4) + 
  coord_equal() +
  theme_bw() + 
  theme(axis.text.x = element_blank(),  # remove x-axis text
        axis.text.y = element_blank(), # remove y-axis text
        axis.ticks = element_blank(),  # remove axis ticks
        axis.title.x = element_text(size=18), # remove x-axis labels
        axis.title.y = element_text(size=18), # remove y-axis labels
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_blank())

```

#Alpha diversity

```{r, echo=FALSE, fig.cap= "Alpha diversity grouped by site and Treatment"}
Alpharesults <- cbind(BeesManagement,diversity(BeesOnly))
colnames(Alpharesults) <- c("ID","Site", "Treatment", "Crop", "Diversity")
ggplot(Alpharesults, aes(x = Site, y = Diversity))+ geom_boxplot(aes(color = Treatment))
Alphasummary <- group_by(Alpharesults, Site, Treatment)
Alphasummary <- summarize(Alphasummary, Mean = mean(Diversity), SD = sd(Diversity))

kable(Alphasummary)
```

```{r, echo=FALSE, fig.cap= "Alpha diversity grouped by site and Treatment"}
dodge <- position_dodge(width=0.9)

ggplot(Alphasummary, aes(x = Site, y = Mean)) + geom_bar(position = "dodge",stat = "identity", aes(fill = Treatment))
```

```{r, echo=FALSE, cache=TRUE}
glmalpha <- glmulti(glm(Diversity~ Site + Treatment + Crop, data = Alpharesults), crit = "aicc")

kable(weightable(glmalpha))

```


```{r, echo=FALSE, cache=TRUE, results='asis'}
lme.model  =  lmer(Diversity~Treatment +  (1|Site) + (1|Crop), data = Alpharesults)

stargazer(lme.model)
```